<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARC Converter | Template Engine</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <link id="theme-stylesheet" rel="stylesheet" href="{{ url_for('static', filename='theme-futuristic.css') }}">

  <style>
    #template-switcher-ui {
      position: fixed;
      bottom: 24px;
      left: 24px;
      z-index: 10000;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Inter', system-ui, sans-serif;
      animation: slideUp 0.5s ease-out;
    }
    #template-switcher-ui label {
      color: #94a3b8;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    #template-select {
      background: transparent;
      color: #f8fafc;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      padding-right: 4px;
    }
    #template-select option { background: #0f172a; color: #f8fafc; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

  <div id="template-switcher-ui">
    <label for="template-select">Design System:</label>
    <select id="template-select" onchange="loadTheme(this.value)">
      <option value="futuristic" selected>Cyberpunk Glass</option>
      <option value="classic">Classic / Original</option>
      <option value="brutalist">Neo-Brutalism</option>
      <option value="editorial">Modern Editorial</option>
    </select>
  </div>

  <div id="app-root"></div>

  <script>
    // --- SHARED CONTENT CONSTANTS (To ensure no data is lost) ---
    const FIELDS_HTML = `
      <div class="field-item"><span class="field-badge">020$a</span><span class="field-desc">ISBN (multiple with |)</span></div>
      <div class="field-item"><span class="field-badge">020$c</span><span class="field-desc">Terms of availability</span></div>
      <div class="field-item"><span class="field-badge">082$a</span><span class="field-desc">Classification number</span></div>
      <div class="field-item"><span class="field-badge">082$b</span><span class="field-desc">Item number</span></div>
      <div class="field-item"><span class="field-badge">100$a</span><span class="field-desc">Main Author</span></div>
      <div class="field-item"><span class="field-badge">245$a</span><span class="field-desc">Title</span></div>
      <div class="field-item"><span class="field-badge">245$b</span><span class="field-desc">Remainder of title</span></div>
      <div class="field-item"><span class="field-badge">250$a</span><span class="field-desc">Edition statement</span></div>
      <div class="field-item"><span class="field-badge">260$a</span><span class="field-desc">Place of publication</span></div>
      <div class="field-item"><span class="field-badge">260$b</span><span class="field-desc">Name of publisher</span></div>
      <div class="field-item"><span class="field-badge">260$c</span><span class="field-desc">Date of publication</span></div>
      <div class="field-item"><span class="field-badge">300$a</span><span class="field-desc">Extent</span></div>
      <div class="field-item"><span class="field-badge">362$a</span><span class="field-desc">Dates of publication</span></div>
      <div class="field-item"><span class="field-badge">650$a</span><span class="field-desc">Subject (multiple with |)</span></div>
      <div class="field-item"><span class="field-badge">700$a</span><span class="field-desc">Personal name (multiple with |)</span></div>
      <div class="field-item"><span class="field-badge">952$p</span><span class="field-desc">Barcode</span></div>
      <div class="field-item"><span class="field-badge">952$d</span><span class="field-desc">Date acquired</span></div>
      <div class="field-item"><span class="field-badge">952$o</span><span class="field-desc">Call number</span></div>
      <div class="field-item"><span class="field-badge">952$e</span><span class="field-desc">Source of acquisition</span></div>
      <div class="field-item"><span class="field-badge">952$g</span><span class="field-desc">Price</span></div>
      <div class="field-item"><span class="field-badge">952$A</span><span class="field-desc">Invoice number</span></div>
      <div class="field-item"><span class="field-badge">952$B</span><span class="field-desc">Invoice date</span></div>
      <div class="field-item"><span class="field-badge">952$c</span><span class="field-desc">Collection</span></div>
      <div class="field-item"><span class="field-badge">952$C</span><span class="field-desc">Additional collection info</span></div>
      <div class="field-item"><span class="field-badge">952$x</span><span class="field-desc">Format</span></div>
      <div class="field-item"><span class="field-badge">952$y</span><span class="field-desc">Item type</span></div>
      <div class="field-item"><span class="field-badge">952$a</span><span class="field-desc">Home library</span></div>
      <div class="field-item"><span class="field-badge">952$b</span><span class="field-desc">Current library</span></div>`;

    const NOTES_HTML = `
      <ul class="info-list">
        <li>Use pipe <strong>(|)</strong> separator for multiple values in fields like 020$a, 650$a and 700$a</li>
        <li>Headers must match MARC field format exactly (e.g., 245$a, 952$p, 952$c, 952$C)</li>
        <li>Holdings are merged based on: 020$a, 020$c, 082$a, 082$b, 100$a, 245$a, 245$b, 250$a, 260$a, 260$b, 260$c, 300$a, 362$a, 650$a, 700$a</li>
        <li>Ensure 952$d and 952$B are in <strong>YYYY-MM-DD</strong> format</li>
      </ul>`;

    // --- TEMPLATE DEFINITIONS ---
    const THEMES = {
      futuristic: {
        cssFile: 'theme-futuristic.css',
        html: `
        <div class="bg-overlay"></div>
        <div class="container">
          <div class="card space-y-8">
            <div class="theme-toggle"><button id="themeToggle"><svg id="iconSun" class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg id="iconMoon" class="icon icon-sm hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div>
            <div class="header">
              <div class="header-icon-container"><svg class="icon-primary animate-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></div>
              <h1>Excel → MARC Converter</h1>
              <p class="header-subtitle">Next-Gen Data Transformation for Koha Systems</p>
            </div>
            <form id="uploadForm" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data" class="space-y-8">
              <div class="status-message success hidden" id="successMessage"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg> File converted successfully! Downloading...</div>
              <div class="space-y-4">
                <h2 class="section-header"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Source File (.xlsx)</h2>
                <div class="file-upload" id="dropZone">
                  <input type="file" name="file" id="fileInput" accept=".xlsx" required>
                  <div class="upload-content">
                    <svg class="upload-icon" id="uploadIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <svg class="upload-icon hidden" id="fileIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
                    <div><p class="upload-text" id="uploadText">Drag & Drop or Click to Upload</p><p class="upload-subtext" id="uploadSubtext">Max file size: 10MB</p></div>
                  </div>
                </div>
              </div>
              <div class="space-y-4">
                <h2 class="section-header"><svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m9,12 2,2 4,-4"/></svg> MARC Language Code</h2>
                <select name="lang" id="lang" required>
                  <option value="und" selected>Undefined (und)</option><option value="eng">English (eng)</option><option value="hin">Hindi (hin)</option><option value="ben">Bengali (ben)</option><option value="tam">Tamil (tam)</option><option value="tel">Telugu (tel)</option>
                </select>
              </div>
              <div class="btn-container"><button type="submit" class="btn" id="convertBtn" disabled><span id="btnText">Select File First</span><span class="spinner hidden" id="btnSpinner"></span></button></div>
              <div class="space-y-4">
                <h3 class="section-header">Supported Fields</h3>
                <div class="fields-grid">${FIELDS_HTML}</div>
              </div>
              <div class="info-box"><h4 class="info-title">Important Notes:</h4>${NOTES_HTML}</div>
            </form>
          </div>
          <footer><div class="dev-signature"><div class="dev-avatar">SB</div><div class="dev-info"><div class="dev-label">Developed By</div><div class="dev-name">Subhankar Barman</div></div></div></footer>
        </div>`
      },
      classic: {
        cssFile: 'theme-classic.css',
        html: `
        <div class="bg-overlay"></div>
        <div class="container">
          <div class="theme-toggle"><button id="themeToggle"><svg id="iconSun" class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v2m0 14v2m9-9h-2m-14 0H3m16.95-6.95-1.42 1.42M6.34 17.66l-1.42 1.42M17.66 6.34l1.42-1.42M6.34 6.34l-1.42-1.42"/></svg><svg id="iconMoon" class="icon icon-sm hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div>
          <div class="header">
            <div class="header-title">
              <svg class="icon icon-primary animate-float" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
              <h1>Excel → MARC Converter</h1>
            </div>
            <p class="header-subtitle">Transform your Excel (.xlsx) files into Koha-ready MARC (.mrk) format with seamless field merging</p>
          </div>
          <div class="card space-y-8">
            <form id="uploadForm" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data" class="space-y-8">
              <div class="status-message success hidden" id="successMessage"><svg class="icon-sm status-icon" viewBox="0 0 24 24"><polyline points="20,6 9,17 4,12"/></svg> File converted successfully! Downloading...</div>
              <div class="space-y-4">
                <h2 class="section-header"><svg class="icon-sm icon-primary" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Upload Excel File</h2>
                <div class="file-upload" id="dropZone">
                  <input type="file" name="file" id="fileInput" accept=".xlsx" required>
                  <div class="upload-content">
                    <div class="upload-icon-container"><svg class="icon-lg upload-icon" id="uploadIcon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><svg class="icon-lg upload-icon hidden" id="fileIcon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg><svg class="icon-sm upload-check hidden" id="checkIcon" viewBox="0 0 24 24"><polyline points="20,6 9,17 4,12"/></svg></div>
                    <div><p class="upload-text" id="uploadText">Click or drag Excel file here</p><p class="upload-subtext" id="uploadSubtext">Supports .xlsx files up to 10MB</p></div>
                  </div>
                </div>
              </div>
              <div class="space-y-4">
                <h2 class="section-header"><svg class="icon-sm icon-primary" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="m9,12 2,2 4,-4"/></svg> MARC Language Code</h2>
                <select name="lang" id="lang" required>
                  <option value="und" selected>Undefined</option><option value="eng">English (eng)</option><option value="hin">Hindi (hin)</option><option value="ben">Bengali (ben)</option><option value="tam">Tamil (tam)</option><option value="tel">Telugu (tel)</option>
                </select>
              </div>
              <div class="btn-container"><button type="submit" class="btn" id="convertBtn" disabled><span id="btnText">Select File First</span><span class="spinner hidden" id="btnSpinner"></span></button></div>
              <div class="space-y-4"><h3 class="section-header section-header-lg">Supported Fields</h3><div class="fields-grid">${FIELDS_HTML}</div></div>
              <div class="info-box"><h4 class="info-title">Important Notes:</h4>${NOTES_HTML}</div>
            </form>
          </div>
          <footer class="app-footer"><div class="footer-content"><p>Developed by <span class="developer-name">Subhankar Barman</span></p><span class="divider">•</span><p class="copyright">&copy; <script>document.write(new Date().getFullYear())<\/script> MARC Converter</p></div></footer>
        </div>`
      },
      brutalist: {
        cssFile: 'theme-brutalist.css',
        html: `
        <div class="container">
          <div class="main-card">
            <div class="theme-toggle"><button id="themeToggle"><svg id="iconSun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg id="iconMoon" class="hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div>
            <div class="header">
              <div class="brand-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></div>
              <h1>Excel // MARC</h1>
              <p class="subtitle">SYSTEM :: KOHA DATA CONVERTER V2.0</p>
            </div>
            <form id="uploadForm" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data" class="space-y-8">
              <div class="msg-box msg-success hidden" id="successMessage">SUCCESS: File converted. Download initiated.</div>
              <div>
                <span class="section-title">01 // SELECT SOURCE DATA (.xlsx)</span>
                <div class="file-upload-box" id="dropZone">
                  <input type="file" name="file" id="fileInput" accept=".xlsx" required>
                  <div id="uploadContent">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:1rem; stroke:var(--text-sec);"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    <p class="upload-text" id="uploadText">CLICK TO UPLOAD DATABASE</p>
                  </div>
                </div>
              </div>
              <div>
                <span class="section-title">02 // CONFIGURE ENCODING</span>
                <select name="lang" id="lang" required>
                  <option value="und" selected>Undefined [und]</option><option value="eng">English [eng]</option><option value="hin">Hindi [hin]</option><option value="ben">Bengali [ben]</option><option value="tam">Tamil [tam]</option><option value="tel">Telugu [tel]</option>
                </select>
              </div>
              <button type="submit" class="btn-main" id="convertBtn" disabled><span id="btnText">[ WAITING FOR INPUT ]</span><span class="spinner hidden" id="btnSpinner"></span></button>
              <div>
                <span class="section-title">03 // SYSTEM MAPPING PARAMETERS</span>
                <div class="fields-grid">${FIELDS_HTML.replace(/class="field-item"/g, 'class="field-tag"').replace(/class="field-badge"/g, 'class="tag-code"').replace(/class="field-desc"/g, 'class="tag-desc"')}</div>
                <div style="margin-top:1.5rem; font-size:0.8rem; line-height:1.6; border-top:1px solid var(--text-sec); padding-top:1rem;"><strong>PROTOCOL NOTES:</strong><br>${NOTES_HTML.replace(/<ul class="info-list">/g, '').replace(/<\/ul>/g, '').replace(/<li>/g, '• ').replace(/<\/li>/g, '<br>')}</div>
              </div>
            </form>
          </div>
          <footer class="dev-footer"><div class="dev-badge">DEVELOPED BY <span class="dev-name">Subhankar Barman</span></div></footer>
        </div>`
      },
      editorial: {
        cssFile: 'theme-editorial.css',
        html: `
        <div class="container">
          <div class="editorial-card">
            <div class="theme-toggle"><button id="themeToggle"><svg id="iconSun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg id="iconMoon" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div>
            <div class="header">
              <p class="header-subtitle">Koha Automation Tools</p>
              <h1>Excel to MARC Converter</h1>
            </div>
            <form id="uploadForm" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
              <div class="msg-box msg-success hidden" id="successMessage">Conversion Complete. Downloading file...</div>
              <div>
                <label class="section-label">I. Source Data</label>
                <div class="file-upload-classic" id="dropZone">
                  <input type="file" name="file" id="fileInput" accept=".xlsx" required>
                  <svg class="upload-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="12" y2="12"/><line x1="15" y1="15" x2="12" y2="12"/></svg>
                  <div id="uploadText" style="font-weight: 500;">Select .xlsx File</div>
                  <div id="uploadSubtext" style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">(Max Size: 10MB)</div>
                </div>
              </div>
              <div>
                <label class="section-label">II. Encoding Language</label>
                <select name="lang" id="lang" required>
                  <option value="und" selected>Undefined (und)</option><option value="eng">English (eng)</option><option value="hin">Hindi (hin)</option><option value="ben">Bengali (ben)</option><option value="tam">Tamil (tam)</option><option value="tel">Telugu (tel)</option>
                </select>
              </div>
              <button type="submit" class="btn-gold" id="convertBtn" disabled><span id="btnText">Begin Conversion</span><span class="spinner hidden" id="btnSpinner"></span></button>
              <div class="fields-section">
                <label class="section-label">III. Field Reference</label>
                <div class="fields-grid">${FIELDS_HTML.replace(/class="field-item"/g, 'class="field-item"').replace(/class="field-badge"/g, 'class="field-code"').replace(/class="field-desc"/g, 'class="field-desc"')}</div>
              </div>
            </form>
          </div>
          <footer class="signature-footer"><div class="dev-by">Designed & Developed by</div><div class="dev-name">Subhankar Barman</div></footer>
        </div>`
      }
    };

    // --- LOGIC ---
    const appRoot = document.getElementById('app-root');
    const themeLink = document.getElementById('theme-stylesheet');

    function loadTheme(themeName) {
      const selectedTheme = THEMES[themeName];
      
      // 1. Swap CSS File
      // Note: We use the existing 'static' path structure.
      const staticBase = themeLink.getAttribute('href').split('/').slice(0, -1).join('/');
      themeLink.setAttribute('href', `${staticBase}/${selectedTheme.cssFile}`);

      // 2. Inject HTML
      appRoot.innerHTML = selectedTheme.html;

      // 3. Restore User Preference & Rebind Events
      const currentPref = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', currentPref);
      bindAppEvents(currentPref);
    }

    function bindAppEvents(currentThemePref) {
      // Theme Toggle Logic
      const toggleBtn = document.getElementById('themeToggle');
      const sunIcon = document.getElementById('iconSun');
      const moonIcon = document.getElementById('iconMoon');

      // Set initial state
      if (sunIcon && moonIcon) {
        if (currentThemePref === 'dark') {
          sunIcon.classList.add('hidden');
          moonIcon.classList.remove('hidden');
        } else {
          sunIcon.classList.remove('hidden');
          moonIcon.classList.add('hidden');
        }
      }

      if (toggleBtn) {
        toggleBtn.onclick = (e) => {
          e.preventDefault();
          const html = document.documentElement;
          const oldTheme = html.getAttribute('data-theme');
          const newTheme = oldTheme === 'dark' ? 'light' : 'dark';
          
          html.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);

          if (sunIcon && moonIcon) {
            if (newTheme === 'dark') {
              sunIcon.classList.add('hidden');
              moonIcon.classList.remove('hidden');
            } else {
              sunIcon.classList.remove('hidden');
              moonIcon.classList.add('hidden');
            }
          }
        };
      }

      // Re-bind Drag and Drop (Visuals only, logic handled by scripts.js)
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const uploadText = document.getElementById('uploadText');
      const convertBtn = document.getElementById('convertBtn');
      const btnText = document.getElementById('btnText');

      if (dropZone && fileInput) {
        fileInput.addEventListener('change', () => {
          if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if(uploadText) uploadText.innerText = "✓ Selected: " + fileName;
            if (convertBtn) {
               convertBtn.disabled = false;
               if(btnText) btnText.innerText = "Convert Now";
               else convertBtn.innerText = "Convert Now"; 
            }
          }
        });

        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.style.transform = "scale(1.02)";
            if(dropZone.classList.contains('file-upload')) dropZone.style.borderColor = "var(--primary)";
          }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.style.transform = "scale(1)";
            if(dropZone.classList.contains('file-upload')) dropZone.style.borderColor = ""; 
          }, false);
        });
      }
    }

    // INITIAL LOAD
    loadTheme('futuristic');
  </script>

  <script src="{{ url_for('static', filename='scripts.js') }}"></script>
</body>
</html>
